# 01 Requirements（需要分析・要件定義）

## 1. 目的
本課題では、研究室/組織内の「機材・部品（equipment/parts）」について、**購入から使用、貸出/返却、廃棄までのライフサイクル**を一貫して管理できるデータベースを設計・実装する。

- 管理台帳の一元化（誰が、どこで、何を、どの状態で保持しているか）
- 変更・貸出・廃棄などの**履歴を残し**、後から追跡できるようにする
- 多条件検索により、運用上の問い合わせ（棚卸し/監査/管理者確認）に素早く答えられるようにする

---

## 2. 背景・課題（現状の痛み）
- 機材が増えると、Excel/個人管理では「最新状態」が分からなくなる
- 使用者・責任者・設置場所の更新が追従できず、問い合わせ対応コストが増える
- 貸出/返却が曖昧になり、紛失・重複購入・返却遅延が起こりやすい
- 廃棄済みかどうかの判定が不明確になり、台帳が汚れる

---

## 3. スコープ（対象範囲）

### 3.1 管理対象（データ）
- **部品/機材の基本情報**：管理番号（部品番号）、名称、型番、種類（カテゴリ）、区分（消耗品/備品/資産）
- **学内/資金元番号（備品・資産のみ）**：大学（学内）や資金元が付与する管理番号（例：固定資産番号、備品番号、科研費管理番号など）
- **管理情報**：プロジェクト、責任者、使用者、設置場所
- **状態・履歴**：使用履歴、貸出履歴、廃棄情報（いつ・誰が・何を）
- **購入情報**：発注日、納品日、販売元、価格

### 3.2 対象外（今回は扱わない）
- 在庫数量の自動引当・購買ワークフロー（承認フロー）
- 会計/予算管理、請求書管理
- QR/バーコードの実運用（将来拡張としては可）

---

## 4. 利用者（ステークホルダー）

### 4.1 admin（管理者：台帳管理）
- 新規購入機材の登録
- マスタ（種類・設置場所など）の整備
- 廃棄登録・監査対応

### 4.2 member（学内メンバ：責任者/使用者を含む）
- プロジェクトに紐づく機材の把握
- 使用者・責任者・設置場所の更新（権限範囲内）
- 貸出/返却の実行（権限範囲内）
- 貸出中/返却遅延の確認

### 4.3 viewer / guest（参照のみ）
- 検索・参照のみ（更新系の操作は不可）
- 外部の人物を登録する場合は `guest` として扱い、原則として操作権限を付与しない

---

## 4.4 権限モデル（A案：role ベース）
本課題では、人物（people）に `role` を持たせ、操作可否を制御する（シンプルで課題向き）。

- `admin`：全操作可（登録/変更/配備/貸出返却/故障修理/廃棄/資金元返却/検索）
- `member`：運用操作可（貸出/返却、使用者・責任者変更、配備などを権限範囲内で実行）
- `viewer`：検索のみ（参照専用）
- `guest`：原則として操作不可（外部人物。参照は必要に応じて許可）

> 実装では、操作ログ（履歴）の `actor`（実行者）は `admin` / `member` のみを想定し、`guest` は貸出先など「対象（party）」として登場させる。

---

## 5. 業務フロー（ライフサイクル）

1. **購入**：発注→納品→台帳登録（基本情報＋購入情報を登録）
2. **配備**：プロジェクト・設置場所・責任者を設定（例：Project X / 実験室A / 責任者=Aさん。必要に応じて `status` を `in_service` に更新）
3. **使用**：使用者が変更される（例：Aさん → Bさんへ使用者変更。変更履歴を残す。必要に応じて `status` を `assigned` に更新）
4. **貸出**：貸出登録（例：貸出日=2025-12-16、貸出先=外部先（guest）/学内メンバ、担当=Aさん）→ `status` を `loaned` に更新（貸出履歴・状態遷移履歴を記録）
5. **返却**：返却登録（返却日/返却先）→ 返却先に応じて `status` を更新（例：`in_stock` / `assigned` / `in_service` / `returned_to_funder`）（返却履歴・状態遷移履歴を記録）
6. **廃棄/資金元返却**：廃棄登録（廃棄日/理由/担当）→ `status` を `discarded` に更新、または 資金元へ返却登録（返却日/担当）→ `status` を `returned_to_funder` に更新（いずれも履歴・状態遷移履歴を記録）

> ポイント：**「現在状態（最新）」と「履歴（過去）」を両方管理**する。

---

## 6. 機能要件（必須）

> 共通方針：重要操作（登録/変更/貸出返却/故障修理/廃棄/資金元返却）は、いずれも **履歴（イベント）として記録**し、同時に必要な場合は「現在状態（最新）」側の `status` や関連項目を更新する。

> 権限：更新系操作（FR-01〜FR-06）は原則 `admin` / `member` のみ実行可能とし、`viewer` / `guest` は FR-07（検索）のみを許可する。

### FR-01 新規購入部品/機材の登録
- 入力：基本情報（部品番号/名称/型番/種類/区分）＋購入情報（発注日/納品日/販売元/価格）
- （備品・資産の場合）学内/資金元番号を登録できる
  - 例：固定資産番号、備品番号、科研費管理番号など（複数種類を想定）
- 出力：登録された機材レコード（初期 `status` は原則 `in_stock`）

### FR-02 配備（設置・稼働開始）
- 機材に対して、プロジェクト・設置場所・責任者を設定できる
- 配備により稼働開始する場合、`status` を `in_service` に更新できる
- 配備（変更）内容は履歴として残す（いつ、誰が、どこへ設置したか）

### FR-03 使用者・責任者の変更
- 機材の「現在の使用者/責任者」を更新できる
- 必要に応じて `status` を `assigned` に更新できる（学内個人へ割当）
- 変更前後が追跡できるように **履歴を残す**（いつ、誰が、誰から誰へ）

### FR-04 貸出・返却
- 貸出：貸出日、貸出先（= 学内メンバ or 外部先（guest））、担当者を記録する
- 貸出登録時に `status` を `loaned` に更新する
- 返却：返却日、返却先（在庫へ戻す/学内個人へ割当/設置へ戻す/資金元へ返却 など）を記録する
- 返却登録時に `status` を返却先に応じて更新する（例：`in_stock` / `assigned` / `in_service` / `returned_to_funder`）
- **貸出/返却は履歴として必ず残す**（いつ、誰が、どの機材を、どこへ/誰へ、どの操作をしたか）

### FR-05 故障・修理
- 故障登録：故障日、内容（任意）、担当者を記録し、`status` を `broken` に更新できる
- 修理開始：開始日、内容（任意）、担当者を記録し、`status` を `repairing` に更新できる
- 修理完了：完了日、結果（任意）、担当者を記録し、復旧先に応じて `status` を `in_service` または `in_stock` に更新できる
- 上記の状態変更は **状態遷移履歴として記録・管理**する

### FR-06 廃棄・資金元返却
- 廃棄登録：廃棄日、理由、担当者を記録し、`status` を `discarded` に更新する
- 資金元返却登録：返却日、返却先=資金元（または提供元）、担当者を記録し、`status` を `returned_to_funder` に更新する
- `discarded` / `returned_to_funder` は原則として運用操作対象外（貸出/返却/使用者変更などを不可にする：制約または運用ルール）
- いずれも **履歴・状態遷移履歴を記録**し、後から追跡できること

### FR-07 多条件検索（照会）
- 条件例：使用者、期間、プロジェクト、種類、設置場所、区分（消耗品/備品/資産）、ステータス
- AND/OR を含む複合条件検索を想定
- 例：
  - 貸出中（`loaned`）の一覧
  - 故障中/修理中（`broken`/`repairing`）の一覧
  - 資金元返却済み（`returned_to_funder`）の一覧
  - 特定プロジェクト×特定設置場所×期間内に状態変化があった機材

---

## 7. 非機能要件

### NFR-01 データ整合性
- 主キー/外部キー/NOT NULL/UNIQUE など制約により矛盾を防ぐ
- 参照先（人/プロジェクト/場所）が存在しない状態での登録を防止

### NFR-02 監査性（トレーサビリティ）
- 重要操作（使用者変更、貸出/返却、廃棄、資金元返却、故障/修理）は履歴として残す
- 「いつ、誰が、何を、どう変更したか」を確認できる

### NFR-03 トランザクション
- 貸出/返却/廃棄/資金元返却など複数更新が必要な操作はトランザクションで一括処理
- 失敗時は ROLLBACK できること


### NFR-04 検索性能（最低限）
- 使用者/プロジェクト/種類/場所/区分/ステータス/日付で検索できるよう、必要に応じてインデックスを検討する

### NFR-05 アクセス制御（認可）
- `role`（`admin` / `member` / `viewer` / `guest`）に基づいて操作可否を制御する
- 更新系操作（登録/変更/配備/貸出返却/故障修理/廃棄/資金元返却）は原則 `admin` / `member` のみ許可する
- `viewer` は検索のみ、`guest` は原則として操作不可（参照は必要に応じて許可）
- 重要操作の実行者（actor）は履歴に記録し、監査可能とする

---

## 8. データ要件（設計の前提）

### 8.1 個体管理（asset）
- 同じ型番が複数存在する場合でも、原則として **1台/1個を1レコード**として管理する
- ただし **消耗品**（例：ネジ、電池など）は、運用上「1箱/1パック/1ロット」単位で登録することを許容する
- 消耗品を箱単位で扱う場合は、（後続設計で）`quantity`（数量）や `unit`（単位：箱/本/個 など）を持たせて、入出庫・残量管理の要否を検討する

### 8.2 現在状態と履歴の分離
- 現在状態（誰が使っている、どこにある、ステータス）は「機材テーブル」に保持
- 過去の状態変化（変更・貸出・廃棄）は「履歴テーブル」に保持
- 履歴には、貸出/返却だけでなく、`status` の変更（`in_service`, `assigned`, `loaned`, `broken`, `repairing`, `returned_to_funder`, `discarded` など）も「状態遷移」として記録する

### 8.3 ステータス（検討案）
本システムでは、機材/部品の「現在状態」を `status` として管理し、検索・運用ルール・不正操作防止（例：廃棄済みは貸出不可）に利用する。

#### 状態一覧（推奨）
- `in_stock`：在庫（未配備で保管中。棚/倉庫にある状態）
- `in_service`：稼働中（どこかに設置され、稼働している状態）
- `assigned`：使用中（研究室の研究員・学生など学内の個人に割当され、個人が管理している状態）
- `loaned`：貸出中（外部、または学外を含む貸出中の状態）
- `broken`：故障中（使用不可。復旧待ち）
- `repairing`：修理中（使用不可。修理作業中）
- `returned_to_funder`：資金元へ返却済み（資金元/提供元へ返却し、手元にない状態。原則として運用操作対象外）
- `discarded`：廃棄済み（運用終了。原則として状態を戻さない）

#### 利用可否の分類（運用ルール）
- **利用可能**：`in_stock`, `in_service`, `assigned`
- **利用不可**：`loaned`, `broken`, `repairing`, `returned_to_funder`, `discarded`

#### 代表的な状態遷移（例）
- `in_stock` → `in_service`（設置して稼働）
- `in_stock` → `assigned`（個人へ割当）
- `assigned` → `loaned`（外部/学外へ貸出）
- `loaned` → `assigned` / `in_stock`（返却先に応じて分岐）
- `*` → `broken` → `repairing` → `in_stock`（復旧して在庫へ戻す例）
- `*` → `discarded`（廃棄登録：以後は原則として運用操作対象外）
- `*` → `returned_to_funder`（資金元へ返却：以後は原則として運用操作対象外）
- `loaned` → `returned_to_funder`（貸出先から直接、資金元へ返却するケース）

> 注：実装では `status` の値を列挙（ENUM など）で制約するか、参照テーブル化して管理するかを `docs/05_physical_design.md` で決定する。

> 実際の値は `sql/01_schema.sql` と `docs/05_physical_design.md` で最終確定する。

### 8.4 区分（消耗品/備品/資産）と学内/資金元番号の管理
機材/部品は運用上、以下の区分で扱う。

- **消耗品（consumable）**：使用により減耗し、継続的に補充が発生しうるもの
- **備品（equipment）**：繰り返し利用する物品（学内ルールで備品番号が付与される場合がある）
- **資産（asset）**：固定資産等として管理され、資産番号など大学/資金元の番号が付与されるもの

#### 学内/資金元番号（備品・資産）
備品・資産の一部には、部品番号とは別に「大学や資金元に配分される番号」が存在するため、**別項目として管理**する。

- 例：固定資産番号、備品番号、予算/資金元の管理番号（研究費番号等）
- 1つの機材に複数の番号が紐づく可能性がある（大学番号＋資金元番号 など）

#### 設計方針（後続ドキュメントで確定）
- 機材テーブルに `classification`（消耗品/備品/資産）を保持する
- 学内/資金元番号は、
  - (A) 機材テーブルに `university_tag` / `funding_tag` のように列で持つ（番号の種類が固定なら簡単）
  - (B) `equipment_identifiers` のような別テーブルで「番号種別×番号」を複数管理する（拡張に強い）
 いずれにするかを `docs/04_logical_design.md` / `docs/05_physical_design.md` で決定する

> ルール例：`classification` が `consumable` の場合、学内/資金元番号は NULL を許容（または登録不可）とする。

---

## 9. 代表ユースケース（要約）

### UC-01 新規登録（FR-01）
- actor：`admin` / `member`
- 管理者（または学内メンバ）が購入情報を含めて機材を登録 → 台帳に追加され、初期 `status` は原則 `in_stock`

### UC-02 配備（設置・稼働開始）（FR-02）
- actor：`admin` / `member`
- プロジェクト・設置場所・責任者を設定 → 必要に応じて `status` を `in_service` に更新
- 配備内容（いつ/誰が/どこへ設置）は履歴として残る

### UC-03 使用者/責任者変更（FR-03）
- actor：`admin` / `member`
- 例：Aさん → Bさんへ使用者変更 → 現在値更新＋変更履歴追加（必要に応じて `status` を `assigned` に更新）

### UC-04 貸出/返却（FR-04）
- actor：`admin` / `member`
- 貸出登録（学内メンバ or 外部先（guest））→ `status` を `loaned` に更新
- 返却登録（返却先に応じて）→ `status` を `in_stock` / `assigned` / `in_service` / `returned_to_funder` に更新
- 貸出/返却の履歴・状態遷移履歴が残る

### UC-05 故障/修理（FR-05）
- actor：`admin` / `member`
- 故障登録 → `status` を `broken` に更新（履歴・状態遷移履歴を記録）
- 修理開始 → `status` を `repairing` に更新（履歴・状態遷移履歴を記録）
- 修理完了 → 復旧先に応じて `status` を `in_service` または `in_stock` に更新（履歴・状態遷移履歴を記録）

### UC-06 廃棄/資金元返却（FR-06）
- actor：`admin` / `member`
- 廃棄登録 → `status` を `discarded` に更新（以後は原則として運用操作対象外）
- 資金元返却登録 → `status` を `returned_to_funder` に更新（以後は原則として運用操作対象外）
- いずれも履歴・状態遷移履歴が残る

### UC-07 複合条件検索（FR-07）
- actor：`admin` / `member` / `viewer` / `guest`
- 例：特定プロジェクト×特定設置場所×期間内に状態変化があった機材
- 例：貸出中（`loaned`）、故障中/修理中（`broken`/`repairing`）、資金元返却済み（`returned_to_funder`）の一覧
---

## 10. 成果物（このリポジトリで管理するもの）
- `docs/`：需要分析、ユースケース、ER図、論理/物理設計、トランザクション設計、クエリ設計、検証計画
- `sql/`：DDL、初期データ、機能 SQL、トランザクションケース、自由検索
- `tests/`：制約/CRUD/貸出返却/故障修理/廃棄/資金元返却/検索/ROLLBACK、並行実行の手順書
- `evidence/`：実行結果のスクリーンショット

---

## 11. 次のステップ
1. `docs/02_use_cases.md` にユースケースを詳細化（入力/前提/手順/期待結果）
2. `docs/03_er_diagram.md` でエンティティとリレーションを確定
3. `sql/01_schema.sql`（DDL）に落とし込む
